<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Agent Workflow Builder - EgoPanda Creative</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 50%, #2d2d2d 100%);
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
        }

        .workflow-header {
            background: linear-gradient(90deg, #ff6b35, #f7931e);
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(255, 107, 53, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            position: relative;
        }

        .workflow-title {
            font-size: 20px;
            font-weight: bold;
            color: white;
        }

        .workflow-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .workflow-container {
            display: flex;
            height: calc(100vh - 60px);
        }

        .node-palette {
            width: 280px;
            background: rgba(255, 255, 255, 0.05);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            overflow-y: auto;
        }

        .palette-section {
            margin-bottom: 25px;
        }

        .palette-title {
            font-size: 14px;
            font-weight: bold;
            color: #ff6b35;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .node-template {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: grab;
            transition: all 0.3s ease;
            border-left: 4px solid #4CAF50;
            user-select: none;
        }

        .node-template:hover {
            background: rgba(255, 107, 53, 0.2);
            transform: translateX(5px);
        }

        .node-template.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .node-icon {
            font-size: 16px;
            margin-right: 8px;
        }

        .node-name {
            font-weight: bold;
            font-size: 13px;
        }

        .node-desc {
            font-size: 11px;
            color: #ccc;
            margin-top: 4px;
        }

        .workflow-canvas {
            flex: 1;
            position: relative;
            background: 
                radial-gradient(circle at 25px 25px, rgba(255, 255, 255, 0.1) 2px, transparent 0),
                radial-gradient(circle at 75px 75px, rgba(255, 255, 255, 0.05) 1px, transparent 0);
            background-size: 50px 50px;
            overflow: hidden;
        }

        .canvas-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .workflow-node {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            min-width: 180px;
            border: 2px solid #4CAF50;
            cursor: move;
            z-index: 10;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .workflow-node.selected {
            border-color: #ff6b35;
            box-shadow: 0 0 20px rgba(255, 107, 53, 0.5);
        }

        .workflow-node.trigger {
            border-color: #2196F3;
        }

        .workflow-node.action {
            border-color: #4CAF50;
        }

        .workflow-node.condition {
            border-color: #ff9800;
        }

        .node-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .node-title {
            font-weight: bold;
            font-size: 14px;
            margin-left: 8px;
        }

        .node-config {
            font-size: 12px;
            color: #ccc;
        }

        .connection-point {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #ff6b35;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #fff;
            z-index: 15;
        }

        .connection-point.input {
            left: -8px;
            top: 50%;
            transform: translateY(-50%);
        }

        .connection-point.output {
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
        }

        .connection-point:hover {
            background: #f7931e;
            transform: translateY(-50%) scale(1.2);
        }

        .connection-line {
            stroke: #ff6b35;
            stroke-width: 3;
            fill: none;
            marker-end: url(#arrowhead);
        }

        .properties-panel {
            width: 320px;
            background: rgba(255, 255, 255, 0.05);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            overflow-y: auto;
        }

        .properties-title {
            font-size: 16px;
            font-weight: bold;
            color: #ff6b35;
            margin-bottom: 20px;
        }

        .prop-group {
            margin-bottom: 20px;
        }

        .prop-label {
            display: block;
            font-size: 12px;
            font-weight: bold;
            color: #ccc;
            margin-bottom: 6px;
        }

        .prop-input, .prop-select, .prop-textarea {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 8px 12px;
            color: white;
            font-size: 12px;
        }

        .prop-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .webhook-section {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .webhook-url {
            background: rgba(0, 0, 0, 0.3);
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            margin-top: 8px;
            word-break: break-all;
        }

        .integration-badge {
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            margin-right: 5px;
        }

        .test-btn {
            background: #2196F3;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            margin-top: 10px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-active { background: #4CAF50; }
        .status-inactive { background: #666; }
        .status-error { background: #f44336; }

        .minimap {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 100;
        }

        @media (max-width: 1024px) {
            .node-palette, .properties-panel {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Password Protection Check -->
    <script>
        if (!sessionStorage.getItem('adminAuthorized')) {
            window.location.href = 'admin-login.html';
        }
    </script>

    <div class="workflow-header">
        <div class="workflow-title">üîß AI Agent Workflow Builder</div>
        <div class="workflow-actions">
            <button class="btn btn-secondary" onclick="saveWorkflow()">üíæ Save</button>
            <button class="btn btn-secondary" onclick="loadWorkflow()">üìÅ Load</button>
            <button class="btn btn-primary" onclick="deployWorkflow()">üöÄ Deploy</button>
            <button class="btn btn-secondary" onclick="window.open('admin-superpage.html', '_blank')">‚Üê Admin</button>
        </div>
    </div>

    <div class="workflow-container">
        <!-- Node Palette -->
        <div class="node-palette">
            <div class="palette-section">
                <div class="palette-title">Triggers</div>
                <div class="node-template" draggable="true" data-type="trigger" data-subtype="webhook">
                    <div class="node-icon">üîó</div>
                    <div class="node-name">Webhook</div>
                    <div class="node-desc">Receive HTTP requests</div>
                </div>
                <div class="node-template" draggable="true" data-type="trigger" data-subtype="schedule">
                    <div class="node-icon">‚è∞</div>
                    <div class="node-name">Schedule</div>
                    <div class="node-desc">Time-based triggers</div>
                </div>
                <div class="node-template" draggable="true" data-type="trigger" data-subtype="email">
                    <div class="node-icon">üìß</div>
                    <div class="node-name">Email Trigger</div>
                    <div class="node-desc">New email received</div>
                </div>
            </div>

            <div class="palette-section">
                <div class="palette-title">AI Agents</div>
                <div class="node-template" draggable="true" data-type="agent" data-subtype="vanessa">
                    <div class="node-icon">üëë</div>
                    <div class="node-name">Vanessa (VP)</div>
                    <div class="node-desc">Executive decisions</div>
                </div>
                <div class="node-template" draggable="true" data-type="agent" data-subtype="charlie">
                    <div class="node-icon">‚úçÔ∏è</div>
                    <div class="node-name">Charlie</div>
                    <div class="node-desc">Content creation</div>
                </div>
                <div class="node-template" draggable="true" data-type="agent" data-subtype="william">
                    <div class="node-icon">üíª</div>
                    <div class="node-name">William</div>
                    <div class="node-desc">Web development</div>
                </div>
                <div class="node-template" draggable="true" data-type="agent" data-subtype="marsha">
                    <div class="node-icon">üìà</div>
                    <div class="node-name">Marsha</div>
                    <div class="node-desc">Marketing & sales</div>
                </div>
                <div class="node-template" draggable="true" data-type="agent" data-subtype="auto">
                    <div class="node-icon">‚öôÔ∏è</div>
                    <div class="node-name">Auto</div>
                    <div class="node-desc">Business operations</div>
                </div>
            </div>

            <div class="palette-section">
                <div class="palette-title">Actions</div>
                <div class="node-template" draggable="true" data-type="action" data-subtype="google-drive">
                    <div class="node-icon">üìÅ</div>
                    <div class="node-name">Google Drive</div>
                    <div class="node-desc">File operations</div>
                </div>
                <div class="node-template" draggable="true" data-type="action" data-subtype="gmail">
                    <div class="node-icon">üìß</div>
                    <div class="node-name">Gmail</div>
                    <div class="node-desc">Send/read emails</div>
                </div>
                <div class="node-template" draggable="true" data-type="action" data-subtype="slack">
                    <div class="node-icon">üí¨</div>
                    <div class="node-name">Slack</div>
                    <div class="node-desc">Team messaging</div>
                </div>
                <div class="node-template" draggable="true" data-type="action" data-subtype="database">
                    <div class="node-icon">üóÑÔ∏è</div>
                    <div class="node-name">Database</div>
                    <div class="node-desc">Store/retrieve data</div>
                </div>
            </div>

            <div class="palette-section">
                <div class="palette-title">Logic</div>
                <div class="node-template" draggable="true" data-type="condition" data-subtype="if">
                    <div class="node-icon">üîÄ</div>
                    <div class="node-name">Condition</div>
                    <div class="node-desc">If/then logic</div>
                </div>
                <div class="node-template" draggable="true" data-type="condition" data-subtype="delay">
                    <div class="node-icon">‚è≥</div>
                    <div class="node-name">Delay</div>
                    <div class="node-desc">Wait before next action</div>
                </div>
            </div>
        </div>

        <!-- Canvas -->
        <div class="workflow-canvas" id="canvas">
            <svg class="canvas-svg" id="connectionSvg">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#ff6b35" />
                    </marker>
                </defs>
            </svg>
            
            <!-- Minimap -->
            <div class="minimap">
                <canvas id="minimapCanvas" width="200" height="150"></canvas>
            </div>
        </div>

        <!-- Properties Panel -->
        <div class="properties-panel">
            <div class="properties-title">Node Properties</div>
            <div id="nodeProperties">
                <div style="text-align: center; color: #666; margin-top: 50px;">
                    Select a node to configure
                </div>
            </div>
        </div>
    </div>

    <script>
        class WorkflowBuilder {
            constructor() {
                this.nodes = [];
                this.connections = [];
                this.selectedNode = null;
                this.dragOffset = { x: 0, y: 0 };
                this.connecting = false;
                this.connectionStart = null;
                this.nodeCounter = 1;
                
                this.setupEventListeners();
                this.loadSampleWorkflow();
            }

            setupEventListeners() {
                const canvas = document.getElementById('canvas');
                
                // Drag and drop from palette
                document.querySelectorAll('.node-template').forEach(template => {
                    template.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', JSON.stringify({
                            type: template.dataset.type,
                            subtype: template.dataset.subtype,
                            name: template.querySelector('.node-name').textContent
                        }));
                        template.classList.add('dragging');
                    });
                    
                    template.addEventListener('dragend', () => {
                        template.classList.remove('dragging');
                    });
                });

                canvas.addEventListener('dragover', (e) => e.preventDefault());
                canvas.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                    const rect = canvas.getBoundingClientRect();
                    this.createNode(data, e.clientX - rect.left, e.clientY - rect.top);
                });

                // Canvas click to deselect
                canvas.addEventListener('click', (e) => {
                    if (e.target === canvas) {
                        this.selectNode(null);
                    }
                });
            }

            createNode(nodeData, x, y) {
                const node = {
                    id: `node_${this.nodeCounter++}`,
                    type: nodeData.type,
                    subtype: nodeData.subtype,
                    name: nodeData.name,
                    x: x,
                    y: y,
                    config: this.getDefaultConfig(nodeData.type, nodeData.subtype)
                };

                this.nodes.push(node);
                this.renderNode(node);
                return node;
            }

            getDefaultConfig(type, subtype) {
                const configs = {
                    trigger: {
                        webhook: { url: `https://agent.egopandacreative.com/webhook/${Math.random().toString(36).substr(2, 9)}`, method: 'POST' },
                        schedule: { cron: '0 9 * * *', timezone: 'UTC' },
                        email: { filter: '', folder: 'inbox' }
                    },
                    agent: {
                        vanessa: { task: 'Review and make executive decision', priority: 'high' },
                        charlie: { task: 'Create content', contentType: 'blog' },
                        william: { task: 'Develop features', framework: 'react' },
                        marsha: { task: 'Marketing campaign', platform: 'social' },
                        auto: { task: 'Automate process', workflow: 'standard' }
                    },
                    action: {
                        'google-drive': { operation: 'create', folder: '/Business', permissions: 'edit' },
                        gmail: { operation: 'send', to: '', subject: '' },
                        slack: { channel: '#general', message: '' },
                        database: { operation: 'insert', table: 'tasks' }
                    },
                    condition: {
                        if: { condition: 'equals', value: '' },
                        delay: { duration: 60, unit: 'seconds' }
                    }
                };

                return configs[type]?.[subtype] || {};
            }

            renderNode(node) {
                const canvas = document.getElementById('canvas');
                const nodeEl = document.createElement('div');
                nodeEl.className = `workflow-node ${node.type}`;
                nodeEl.style.left = `${node.x}px`;
                nodeEl.style.top = `${node.y}px`;
                nodeEl.dataset.nodeId = node.id;

                const icon = this.getNodeIcon(node.type, node.subtype);
                const statusColor = this.getNodeStatus(node);

                nodeEl.innerHTML = `
                    <div class="connection-point input" data-node-id="${node.id}" data-type="input"></div>
                    <div class="connection-point output" data-node-id="${node.id}" data-type="output"></div>
                    <div class="node-header">
                        <span class="node-icon">${icon}</span>
                        <span class="node-title">${node.name}</span>
                        <span class="status-indicator status-${statusColor}"></span>
                    </div>
                    <div class="node-config">
                        ${this.getNodeConfigDisplay(node)}
                    </div>
                `;

                // Node click to select
                nodeEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.selectNode(node);
                });

                // Node dragging
                let isDragging = false;
                nodeEl.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('connection-point')) return;
                    isDragging = true;
                    this.dragOffset.x = e.clientX - node.x;
                    this.dragOffset.y = e.clientY - node.y;
                    nodeEl.style.cursor = 'grabbing';
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    node.x = e.clientX - this.dragOffset.x;
                    node.y = e.clientY - this.dragOffset.y;
                    nodeEl.style.left = `${node.x}px`;
                    nodeEl.style.top = `${node.y}px`;
                    this.updateConnections();
                });

                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        nodeEl.style.cursor = 'move';
                    }
                });

                // Connection points
                const connectionPoints = nodeEl.querySelectorAll('.connection-point');
                connectionPoints.forEach(point => {
                    point.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.handleConnectionClick(point);
                    });
                });

                canvas.appendChild(nodeEl);
            }

            getNodeIcon(type, subtype) {
                const icons = {
                    trigger: { webhook: 'üîó', schedule: '‚è∞', email: 'üìß' },
                    agent: { vanessa: 'üëë', charlie: '‚úçÔ∏è', william: 'üíª', marsha: 'üìà', auto: '‚öôÔ∏è' },
                    action: { 'google-drive': 'üìÅ', gmail: 'üìß', slack: 'üí¨', database: 'üóÑÔ∏è' },
                    condition: { if: 'üîÄ', delay: '‚è≥' }
                };
                return icons[type]?.[subtype] || '‚ö™';
            }

            getNodeStatus(node) {
                // Simulate node status based on configuration
                if (node.type === 'trigger' && node.config.url) return 'active';
                if (node.type === 'agent') return 'active';
                if (node.type === 'action' && Object.keys(node.config).length > 0) return 'active';
                return 'inactive';
            }

            getNodeConfigDisplay(node) {
                const config = node.config;
                switch (node.type) {
                    case 'trigger':
                        if (node.subtype === 'webhook') return `POST ${config.url?.split('/').pop() || 'Not configured'}`;
                        if (node.subtype === 'schedule') return `${config.cron || 'Not configured'}`;
                        if (node.subtype === 'email') return `Filter: ${config.filter || 'None'}`;
                        break;
                    case 'agent':
                        return `Task: ${config.task || 'Not configured'}`;
                    case 'action':
                        if (node.subtype === 'google-drive') return `${config.operation || 'read'} in ${config.folder || '/'}`;
                        if (node.subtype === 'gmail') return `${config.operation || 'send'} email`;
                        if (node.subtype === 'slack') return `Post to ${config.channel || '#general'}`;
                        if (node.subtype === 'database') return `${config.operation || 'select'} ${config.table || 'table'}`;
                        break;
                    case 'condition':
                        if (node.subtype === 'if') return `If ${config.condition || 'true'}`;
                        if (node.subtype === 'delay') return `Wait ${config.duration || 60}${config.unit || 's'}`;
                        break;
                }
                return 'Not configured';
            }

            selectNode(node) {
                // Remove previous selection
                document.querySelectorAll('.workflow-node.selected').forEach(el => {
                    el.classList.remove('selected');
                });

                this.selectedNode = node;
                
                if (node) {
                    // Highlight selected node
                    document.querySelector(`[data-node-id="${node.id}"]`).classList.add('selected');
                    this.showNodeProperties(node);
                } else {
                    this.showNodeProperties(null);
                }
            }

            showNodeProperties(node) {
                const panel = document.getElementById('nodeProperties');
                
                if (!node) {
                    panel.innerHTML = `
                        <div style="text-align: center; color: #666; margin-top: 50px;">
                            Select a node to configure
                        </div>
                    `;
                    return;
                }

                panel.innerHTML = `
                    <div class="prop-group">
                        <label class="prop-label">Node Name</label>
                        <input type="text" class="prop-input" value="${node.name}" onchange="workflow.updateNodeProperty('name', this.value)">
                    </div>
                    ${this.generatePropertyInputs(node)}
                    <div class="prop-group">
                        <button class="btn btn-primary" onclick="workflow.testNode('${node.id}')">üß™ Test Node</button>
                        <button class="btn btn-secondary" onclick="workflow.duplicateNode('${node.id}')">üìã Duplicate</button>
                        <button class="btn" style="background: #f44336; color: white;" onclick="workflow.deleteNode('${node.id}')">üóëÔ∏è Delete</button>
                    </div>
                `;
            }

            generatePropertyInputs(node) {
                const config = node.config;
                let html = '';

                switch (node.type) {
                    case 'trigger':
                        if (node.subtype === 'webhook') {
                            html += `
                                <div class="prop-group">
                                    <label class="prop-label">HTTP Method</label>
                                    <select class="prop-select" onchange="workflow.updateNodeConfig('method', this.value)">
                                        <option value="POST" ${config.method === 'POST' ? 'selected' : ''}>POST</option>
                                        <option value="GET" ${config.method === 'GET' ? 'selected' : ''}>GET</option>
                                        <option value="PUT" ${config.method === 'PUT' ? 'selected' : ''}>PUT</option>
                                    </select>
                                </div>
                                <div class="webhook-section">
                                    <div class="prop-label">Webhook URL</div>
                                    <div class="webhook-url">${config.url}</div>
                                    <button class="test-btn" onclick="workflow.copyWebhookUrl('${config.url}')">üìã Copy URL</button>
                                    <button class="test-btn" onclick="workflow.testWebhook('${node.id}')">üß™ Test</button>
                                </div>
                            `;
                        }
                        if (node.subtype === 'schedule') {
                            html += `
                                <div class="prop-group">
                                    <label class="prop-label">Cron Expression</label>
                                    <input type="text" class="prop-input" value="${config.cron || ''}" onchange="workflow.updateNodeConfig('cron', this.value)" placeholder="0 9 * * *">
                                </div>
                                <div class="prop-group">
                                    <label class="prop-label">Timezone</label>
                                    <select class="prop-select" onchange="workflow.updateNodeConfig('timezone', this.value)">
                                        <option value="UTC" ${config.timezone === 'UTC' ? 'selected' : ''}>UTC</option>
                                        <option value="America/New_York" ${config.timezone === 'America/New_York' ? 'selected' : ''}>Eastern</option>
                                        <option value="America/Los_Angeles" ${config.timezone === 'America/Los_Angeles' ? 'selected' : ''}>Pacific</option>
                                    </select>
                                </div>
                            `;
                        }
                        break;

                    case 'agent':
                        html += `
                            <div class="prop-group">
                                <label class="prop-label">Task Description</label>
                                <textarea class="prop-textarea" onchange="workflow.updateNodeConfig('task', this.value)" placeholder="Describe what this agent should do...">${config.task || ''}</textarea>
                            </div>
                            <div class="prop-group">
                                <label class="prop-label">Priority</label>
                                <select class="prop-select" onchange="workflow.updateNodeConfig('priority', this.value)">
                                    <option value="low" ${config.priority === 'low' ? 'selected' : ''}>Low</option>
                                    <option value="medium" ${config.priority === 'medium' ? 'selected' : ''}>Medium</option>
                                    <option value="high" ${config.priority === 'high' ? 'selected' : ''}>High</option>
                                </select>
                            </div>
                        `;
                        break;

                    case 'action':
                        if (node.subtype === 'google-drive') {
                            html += `
                                <div class="prop-group">
                                    <label class="prop-label">Operation</label>
                                    <select class="prop-select" onchange="workflow.updateNodeConfig('operation', this.value)">
                                        <option value="create" ${config.operation === 'create' ? 'selected' : ''}>Create File</option>
                                        <option value="read" ${config.operation === 'read' ? 'selected' : ''}>Read File</option>
                                        <option value="update" ${config.operation === 'update' ? 'selected' : ''}>Update File</option>
                                        <option value="delete" ${config.operation === 'delete' ? 'selected' : ''}>Delete File</option>
                                    </select>
                                </div>
                                <div class="prop-group">
                                    <label class="prop-label">Folder Path</label>
                                    <input type="text" class="prop-input" value="${config.folder || ''}" onchange="workflow.updateNodeConfig('folder', this.value)" placeholder="/Business/Reports">
                                </div>
                                <div class="prop-group">
                                    <label class="prop-label">Permissions</label>
                                    <select class="prop-select" onchange="workflow.updateNodeConfig('permissions', this.value)">
                                        <option value="view" ${config.permissions === 'view' ? 'selected' : ''}>View Only</option>
                                        <option value="edit" ${config.permissions === 'edit' ? 'selected' : ''}>Edit</option>
                                        <option value="admin" ${config.permissions === 'admin' ? 'selected' : ''}>Admin</option>
                                    </select>
                                </div>
                                <div class="integration-badge">Google Drive</div>
                            `;
                        }
                        if (node.subtype === 'gmail') {
                            html += `
                                <div class="prop-group">
                                    <label class="prop-label">Operation</label>
                                    <select class="prop-select" onchange="workflow.updateNodeConfig('operation', this.value)">
                                        <option value="send" ${config.operation === 'send' ? 'selected' : ''}>Send Email</option>
                                        <option value="read" ${config.operation === 'read' ? 'selected' : ''}>Read Email</option>
                                        <option value="reply" ${config.operation === 'reply' ? 'selected' : ''}>Reply</option>
                                    </select>
                                </div>
                                <div class="prop-group">
                                    <label class="prop-label">To Email</label>
                                    <input type="email" class="prop-input" value="${config.to || ''}" onchange="workflow.updateNodeConfig('to', this.value)" placeholder="client@example.com">
                                </div>
                                <div class="prop-group">
                                    <label class="prop-label">Subject</label>
                                    <input type="text" class="prop-input" value="${config.subject || ''}" onchange="workflow.updateNodeConfig('subject', this.value)" placeholder="Email subject">
                                </div>
                                <div class="integration-badge">Gmail</div>
                            `;
                        }
                        break;
                }

                return html;
            }

            updateNodeProperty(property, value) {
                if (this.selectedNode) {
                    this.selectedNode[property] = value;
                    this.refreshNodeDisplay(this.selectedNode);
                }
            }

            updateNodeConfig(key, value) {
                if (this.selectedNode) {
                    this.selectedNode.config[key] = value;
                    this.refreshNodeDisplay(this.selectedNode);
                }
            }

            refreshNodeDisplay(node) {
                const nodeEl = document.querySelector(`[data-node-id="${node.id}"]`);
                if (nodeEl) {
                    nodeEl.querySelector('.node-title').textContent = node.name;
                    nodeEl.querySelector('.node-config').textContent = this.getNodeConfigDisplay(node);
                }
            }

            handleConnectionClick(point) {
                const nodeId = point.dataset.nodeId;
                const pointType = point.dataset.type;

                if (!this.connecting) {
                    // Start connection
                    if (pointType === 'output') {
                        this.connecting = true;
                        this.connectionStart = { nodeId, type: pointType };
                        point.style.background = '#f7931e';
                    }
                } else {
                    // Complete connection
                    if (pointType === 'input' && nodeId !== this.connectionStart.nodeId) {
                        this.createConnection(this.connectionStart.nodeId, nodeId);
                    }
                    // Reset connection state
                    this.connecting = false;
                    document.querySelectorAll('.connection-point').forEach(p => {
                        p.style.background = '#ff6b35';
                    });
                    this.connectionStart = null;
                }
            }

            createConnection(fromNodeId, toNodeId) {
                const connection = {
                    id: `conn_${Date.now()}`,
                    from: fromNodeId,
                    to: toNodeId
                };
                this.connections.push(connection);
                this.updateConnections();
            }

            updateConnections() {
                const svg = document.getElementById('connectionSvg');
                svg.innerHTML = svg.innerHTML.replace(/<path.*?<\/path>/g, '');

                this.connections.forEach(conn => {
                    const fromNode = this.nodes.find(n => n.id === conn.from);
                    const toNode = this.nodes.find(n => n.id === conn.to);
                    
                    if (fromNode && toNode) {
                        const fromX = fromNode.x + 180;
                        const fromY = fromNode.y + 40;
                        const toX = toNode.x;
                        const toY = toNode.y + 40;

                        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                        const midX = (fromX + toX) / 2;
                        path.setAttribute('d', `M ${fromX} ${fromY} C ${midX} ${fromY}, ${midX} ${toY}, ${toX} ${toY}`);
                        path.setAttribute('class', 'connection-line');
                        svg.appendChild(path);
                    }
                });
            }

            testNode(nodeId) {
                const node = this.nodes.find(n => n.id === nodeId);
                if (node) {
                    alert(`Testing ${node.name}...\n\nThis would execute a test run of the node with current configuration.`);
                }
            }

            copyWebhookUrl(url) {
                navigator.clipboard.writeText(url);
                alert('Webhook URL copied to clipboard!');
            }

            testWebhook(nodeId) {
                const node = this.nodes.find(n => n.id === nodeId);
                if (node && node.config.url) {
                    alert(`Testing webhook ${node.config.url}...\n\nThis would send a test payload to verify the webhook is working.`);
                }
            }

            deleteNode(nodeId) {
                if (confirm('Are you sure you want to delete this node?')) {
                    // Remove connections
                    this.connections = this.connections.filter(conn => 
                        conn.from !== nodeId && conn.to !== nodeId
                    );
                    
                    // Remove node
                    this.nodes = this.nodes.filter(n => n.id !== nodeId);
                    
                    // Remove from DOM
                    document.querySelector(`[data-node-id="${nodeId}"]`).remove();
                    
                    // Update display
                    this.updateConnections();
                    this.selectNode(null);
                }
            }

            loadSampleWorkflow() {
                // Create a sample workflow to demonstrate
                const webhook = this.createNode({type: 'trigger', subtype: 'webhook', name: 'Client Request'}, 100, 100);
                const vanessa = this.createNode({type: 'agent', subtype: 'vanessa', name: 'Vanessa Review'}, 350, 100);
                const auto = this.createNode({type: 'agent', subtype: 'auto', name: 'Auto Process'}, 600, 100);
                const drive = this.createNode({type: 'action', subtype: 'google-drive', name: 'Save to Drive'}, 850, 100);

                // Create connections
                setTimeout(() => {
                    this.createConnection(webhook.id, vanessa.id);
                    this.createConnection(vanessa.id, auto.id);
                    this.createConnection(auto.id, drive.id);
                }, 100);
            }
        }

        // Global functions
        function saveWorkflow() {
            const workflowData = {
                nodes: workflow.nodes,
                connections: workflow.connections,
                name: 'My Workflow',
                created: new Date().toISOString()
            };
            
            localStorage.setItem('workflow_current', JSON.stringify(workflowData));
            alert('Workflow saved successfully!');
        }

        function loadWorkflow() {
            const saved = localStorage.getItem('workflow_current');
            if (saved) {
                const data = JSON.parse(saved);
                workflow.nodes = data.nodes;
                workflow.connections = data.connections;
                
                // Clear canvas and re-render
                document.getElementById('canvas').innerHTML = `
                    <svg class="canvas-svg" id="connectionSvg">
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#ff6b35" />
                            </marker>
                        </defs>
                    </svg>
                    <div class="minimap">
                        <canvas id="minimapCanvas" width="200" height="150"></canvas>
                    </div>
                `;
                
                workflow.nodes.forEach(node => workflow.renderNode(node));
                workflow.updateConnections();
                alert('Workflow loaded successfully!');
            } else {
                alert('No saved workflow found.');
            }
        }

        function deployWorkflow() {
            const activeNodes = workflow.nodes.length;
            const activeConnections = workflow.connections.length;
            
            if (activeNodes === 0) {
                alert('No nodes to deploy. Please add some nodes to your workflow first.');
                return;
            }
            
            alert(`Deploying workflow with ${activeNodes} nodes and ${activeConnections} connections...\n\nThis would:\n‚Ä¢ Generate webhook endpoints\n‚Ä¢ Configure agent permissions\n‚Ä¢ Set up monitoring\n‚Ä¢ Activate all triggers\n\nWorkflow will be live in production!`);
        }

        // Initialize the workflow builder
        const workflow = new WorkflowBuilder();
    </script>
</body>
</html>
